<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>프로필 이미지 업로드 테스트</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 760px; margin: 24px auto; padding: 0 16px; }
    fieldset { margin: 16px 0; padding: 12px; }
    label { display: block; margin: 8px 0 4px; }
    input[type="text"], input[type="password"] { width: 100%; padding: 8px; box-sizing: border-box; }
    button { padding: 8px 12px; margin-right: 8px; }
    pre { background: #f6f8fa; padding: 12px; overflow: auto; }
    .row { display: flex; gap: 12px; }
    .row > div { flex: 1; }
    small { color: #555; }
  </style>
</head>
<body>
  <h1>프로필 이미지 업로드 테스트</h1>
  <p><small>동일 오리진(서버에서 이 HTML을 직접 열었을 때) 기준으로 동작합니다.</small></p>

  <fieldset>
    <legend>1) 로그인 (토큰 받기)</legend>
    <div class="row">
      <div>
        <label for="username">username</label>
        <input id="username" type="text" autocomplete="username" placeholder="test1" />
      </div>
      <div>
        <label for="password">password</label>
        <input id="password" type="password" autocomplete="current-password" placeholder="test1234!" />
      </div>
    </div>

    <div style="margin-top: 10px;">
      <button id="btnLogin" type="button">로그인</button>
      <button id="btnClearToken" type="button">토큰 지우기</button>
    </div>

    <label for="token">token (Authorization)</label>
    <input id="token" type="text" placeholder="Bearer ..." />
    <small>서버 응답 token은 이미 'Bearer '가 포함됩니다.</small>
  </fieldset>

  <fieldset>
    <legend>2) 프로필 이미지 업로드</legend>

    <label for="file">이미지 파일 (jpg/png/webp)</label>
    <input id="file" type="file" accept="image/png,image/jpeg,image/webp" />

    <div style="margin-top: 10px;">
      <button id="btnUpload" type="button">업로드</button>
    </div>

    <div id="result" style="margin-top: 12px;"></div>
  </fieldset>

  <fieldset>
    <legend>로그</legend>
    <pre id="log"></pre>
  </fieldset>

<script>
  const $ = (id) => document.getElementById(id);

  function log(message, obj) {
    const lines = [];
    lines.push(`[${new Date().toISOString()}] ${message}`);
    if (obj !== undefined) {
      try {
        lines.push(typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2));
      } catch {
        lines.push(String(obj));
      }
    }
    $('log').textContent = lines.join('\n') + "\n\n" + $('log').textContent;
  }

  function setToken(token) {
    $('token').value = token || '';
    if (token) {
      localStorage.setItem('authToken', token);
    } else {
      localStorage.removeItem('authToken');
    }
  }

  function getToken() {
    return $('token').value?.trim() || '';
  }

  // Load token from storage
  setToken(localStorage.getItem('authToken') || '');

  $('btnClearToken').addEventListener('click', () => {
    setToken('');
    log('토큰을 지웠습니다.');
  });

  $('btnLogin').addEventListener('click', async () => {
    const username = $('username').value.trim();
    const password = $('password').value;

    if (!username || !password) {
      alert('username/password를 입력하세요.');
      return;
    }

    try {
      log('로그인 요청 시작');
      const res = await fetch('/api/user/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch { json = { raw: text }; }

      log(`로그인 응답: ${res.status}`, json);

      if (!res.ok) {
        alert(`로그인 실패: ${res.status}`);
        return;
      }

      const token = json.token || res.headers.get('Authorization') || '';
      if (!token) {
        alert('토큰을 응답에서 찾지 못했습니다.');
        return;
      }

      setToken(token);
      alert('로그인 성공: 토큰 저장 완료');
    } catch (e) {
      log('로그인 요청 에러', String(e));
      alert('로그인 요청 중 에러');
    }
  });

  $('btnUpload').addEventListener('click', async () => {
    const token = getToken();
    const file = $('file').files?.[0];

    if (!file) {
      alert('파일을 선택하세요.');
      return;
    }
    if (!token) {
      alert('토큰이 없습니다. 먼저 로그인하세요.');
      return;
    }

    const form = new FormData();
    form.append('file', file);

    try {
      log('업로드 요청 시작', { name: file.name, type: file.type, size: file.size });

      const res = await fetch('/api/user/profile/image', {
        method: 'POST',
        headers: {
          'Authorization': token
        },
        body: form
      });

      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch { json = { raw: text }; }

      log(`업로드 응답: ${res.status}`, json);

      if (!res.ok) {
        alert(`업로드 실패: ${res.status}`);
        return;
      }

      const url = json.profileImageUrl;
      if (url) {
        $('result').innerHTML = `<p>업로드 성공</p><p><a href="${url}" target="_blank" rel="noreferrer">${url}</a></p><img src="${url}" alt="profile" style="max-width: 240px; border: 1px solid #ddd;" />`;
      } else {
        $('result').textContent = '업로드는 됐지만 URL을 받지 못했습니다.';
      }

      alert('업로드 성공');
    } catch (e) {
      log('업로드 요청 에러', String(e));
      alert('업로드 요청 중 에러');
    }
  });
</script>
</body>
</html>
